# wa_color
python3 webscraper for AMU website


sends e-mails when the lesson plan or class cancellations change


---


# reason
* they change the plan so often that i thought it would be kinda convenient
* i have a home server lying around


---


# features
* parses, detects and replaces any broken files (including config)
* sends a list of changes via e-mail in a human-readable format
* fetches the latest win10 chrome header from the [web](https://www.whatismybrowser.com/guides/the-latest-user-agent/) to camouflage itself
* keeps JSON files in RAM to prevent unnecessary reads from disk
* has extensive logging and type hinting built-in
* auto-retries after network error
* can recreate the current and previous lesson plan as two HTML tables for visual comparison


---


# example

```
title: wa_color: lesson plan's table has changed

lesson plan's table has changed at '2022-09-01 02:49:22', here are the differences:
* [friday @ 11:30] 'PYTHON; Smith; 106' --> STAT TOOLS LING; Brown; 151'
* [thursday @ 15:00] '' --> 'LAB PRACTICE; Lecturer; 219'

sent from linux running python 3.9.2
source code: https://github.com/ryouze/wa_color/
```


```
title: wa_color: lesson plan's color has changed

lesson plan's color has changed from '99E0FF' to 'B862C1' at '2022-09-03 23:04:27' (iteration: 3)

full colors history:
* [1] 2022-09-03 19:02:47 - 'FFBFBE'
* [2] 2022-09-03 23:04:27 - '99E0FF'

sent from linux running python 3.9.2
source code: https://github.com/ryouze/wa_color/
```


![autogenerated table](resources/autogenerated_table.jpeg)


---


# structure

* `main.py` - run program
* `config/` - user-defined config files
  * `secret.json` - e-mail credentials
  * `user.json` - config
* `wa_color/` - program's code
  * `communication/` - send e-mail
  * `disk/` - local files
  * `net/` - scrap websites
  * `main.py` - main app and debug class
* `work/` - program-defined data files
  * `cancel.json` - class cancellations
  * `plan.json` - lesson plan


---


# setup

> **NOTE:** this is designed to run 24/7 on a headless linux server<br>the exact time at which a change supposedly occurred is based simply on the current time


### 1. clone the repo

```bash
git clone https://github.com/ryouze/wa_color/
```


### 2. install deps

> **NOTE:** consider creating a venv first: `python3 -m venv ./env --upgrade-deps && source env/bin/activate`<br>if you do create a venv then put full path to the venv's interpreter in systemd's `ExecStart` instead of just `python3`

```bash
pip3 install -r requirements.txt
```


### 3. run once

this will fetch latest lesson plan and class cancellations, then save them to newly creates files

> **NOTE:** wait around 10-15s for it to finish (it will quit immediately after first run)

```bash
python3 main.py
```


### 4. edit settings

```bash
nano config/user.json
```


```
* loop_time_in_seconds - how much to wait in seconds between each loop (e.g., 900, 3600, 7200).
-> if set to 0 (default), then run only once, then quit.
* send_email_cancel - should an e-mail be sent on class cancellations change (e.g., true; disable if spam).
* send_email_plan - should an e-mail be sent on lesson plan change (e.g., true).
* group_pattern - regex pattern used to find your lesson group (e.g., "^1.*LMT").
* cancel - link to a list of class cancellations.
* plan - link to a list of lesson plans for all groups.
```


### 5. edit credentials

```bash
nano config/secret.json
```


```
* email_receivers - list of e-mail addresses to send message to (e.g., ["name.surname@mail.com"]).
* password - your e-mail password (e.g., "123").
* port - your outgoing e-mail port (e.g., 465).
* server - your outgoing e-mail server (e.g., "example.mail.com",).
* username - your e-mail address (e.g., "name.surname@example.mail.com").
```

requires an e-mail with smtp support (throwaway at o2 works ig)


### 6. create systemd service

>**NOTE:** the `ExecStartPre` adds a startup delay (40 seconds) to prevent the program from using the fallback user agent<br>if you use a different init system (or a cron job or a scheduled task) them make sure to add a delay of a similar length

```bash
cd /etc/systemd/system
sudo nano wa_color.service
```

enter username and path to wa_color dir here

```bash
[Unit]
Description=wa_color (python3)

Wants=network.target
After=syslog.target network-online.target

[Service]
User=rin
WorkingDirectory=/home/rin/wa_color
ExecStartPre=/bin/sleep 40
ExecStart=python3 /home/rin/wa_color/main.py
Restart=on-failure
RestartSec=300
KillMode=mixed
TimeoutStartSec=120

[Install]
WantedBy=multi-user.target
```


### 7. run systemd service


(I) autostart service on OS boot (e.g., after restart, power cut)
```bash
sudo systemctl enable wa_color.service
```

(II) start manually right now

>**NOTE:** the `ExecStartPre` adds a startup delay (40 seconds), which will make the shell unresponsive for 40 seconds before starting the program; since i rarely start it this way, i haven't bothered adding a delay in the program itself

```bash
sudo systemctl start wa_color.service
```

(III) check status
```bash
systemctl status wa_color.service
```

now it's gonna check the AMU website every X seconds (as specified in `./config/user.json`) and send e-mails


---


# problems

if it fails to run, check if you have:

* a) all the dependencies installed (requests, bs4)
* b) activated the virtual environment (`source env/bin/activate`)
* c) entered the correct paths in the systemd service (workdir, main.py)
* d) tried running the command in systemd's `ExecStart` directly (e.g., `python3 /home/rin/wa_color/main.py`)
* e) read/write permissions in the wa_color dir (`chmod +rw <directory>`)


---


# args

the program can take multiple commandline arguments


a) verbose - enable verbose, debug-level logging, useful for debugging


```bash
python3 main.py --verbose
```


b) html - create a html table of the current and previous lesson plan (for comparison), then save it in `./output.html`, then quit (no web scraper)


```bash
python3 main.py --html
```


c) mail - send debug e-mail to all recipients in `./config/secret.json`, then quit (no web scraper)


```bash
python3 main.py --mail
```


d) reset - re-create all directories from scratch, fetch all data, then quit (effectively equivalent to re-downloading the whole program and running it for the first time)


```bash
python3 main.py --reset
```
